name = "greenbro-worker"
main = "dist/app.mjs"
compatibility_date = "2025-10-01"
compatibility_flags = ["nodejs_compat"]
minify = true

routes = [
  { pattern = "api.greenbro.co.za/*", custom_domain = true },
  { pattern = "dash.greenbro.co.za/*", custom_domain = true }
]

[build]
command = "npm run build"

[vars]
# Place default dev/test vars here (do not store secrets).

[triggers]
crons = ["0 2 * * *", "*/5 * * * *"]

[[queues.producers]]
queue = "ingest-q"
binding = "INGEST_Q"

[[queues.consumers]]
queue = "ingest-q"
max_batch_size = 50
max_batch_timeout = 30

[durable_objects]
bindings = [
  { name = "DeviceState", class_name = "DeviceStateDO" },
  { name = "DEVICE_DO", class_name = "DeviceDO" }
]

[[migrations]]
tag = "v1-device-state"
new_classes = ["DeviceStateDO"]

[[migrations]]
tag = "v2-device"
new_classes = ["DeviceDO"]

[[d1_databases]]
binding = "DB"
database_name = "GREENBRO_DB"
database_id = "REPLACE_WITH_D1_ID"

[[r2_buckets]]
binding = "REPORTS"
bucket_name = "greenbro-reports"

[[r2_buckets]]
binding = "BRAND"
bucket_name = "greenbro-brand"

[[r2_buckets]]
binding = "ARCHIVE"
bucket_name = "greenbro-archive"

[[kv_namespaces]]
binding = "CONFIG"
id = "REPLACE_WITH_KV_ID"

[env.production]
vars = {
  ACCESS_AUD = "https://access.greenbro.co.za",
  ACCESS_ISS = "https://…",
  ACCESS_JWKS = "https://…/cdn-cgi/access/certs",
  JWT_SECRET = "***"
}

[[env.production.d1_databases]]
binding = "DB"
database_id = "prod-…"
database_name = "greenbro-db-prod"

[[env.production.r2_buckets]]
binding = "REPORTS"
bucket_name = "greenbro-reports-prod"

[[env.production.r2_buckets]]
binding = "BRAND"
bucket_name = "greenbro-brand-prod"

[[env.production.r2_buckets]]
binding = "ARCHIVE"
bucket_name = "greenbro-archive-prod"

[[env.production.kv_namespaces]]
binding = "CONFIG"
id = "kv_settings_prod_…"
